

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>libs.deep_models.flow.lite_flow_net.correlation &mdash; DF-VO 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> DF-VO
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../rsts/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../rsts/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../rsts/examples.html">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../DF-VO/apis.html">apis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../DF-VO/libs.html">libs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../DF-VO/tools.html">tools</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">DF-VO</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
      <li>libs.deep_models.flow.lite_flow_net.correlation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for libs.deep_models.flow.lite_flow_net.correlation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">import</span> <span class="nn">cupy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>

<div class="viewcode-block" id="Stream"><a class="viewcode-back" href="../../../../../DF-VO/libs.deep_models.flow.lite_flow_net.correlation.html#libs.deep_models.flow.lite_flow_net.correlation.Stream">[docs]</a><span class="k">class</span> <span class="nc">Stream</span><span class="p">:</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">current_stream</span><span class="p">()</span><span class="o">.</span><span class="n">cuda_stream</span></div>
<span class="c1"># end</span>

<span class="n">kernel_Correlation_rearrange</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">	extern &quot;C&quot; __global__ void kernel_Correlation_rearrange(</span>
<span class="s1">		const int n,</span>
<span class="s1">		const float* input,</span>
<span class="s1">		float* output</span>
<span class="s1">	) {</span>
<span class="s1">	  int intIndex = (blockIdx.x * blockDim.x) + threadIdx.x;</span>

<span class="s1">	  if (intIndex &gt;= n) {</span>
<span class="s1">	    return;</span>
<span class="s1">	  }</span>

<span class="s1">	  int intSample = blockIdx.z;</span>
<span class="s1">	  int intChannel = blockIdx.y;</span>

<span class="s1">	  float dblValue = input[(((intSample * SIZE_1(input)) + intChannel) * SIZE_2(input) * SIZE_3(input)) + intIndex];</span>

<span class="s1">	  __syncthreads();</span>

<span class="s1">	  int intPaddedY = (intIndex / SIZE_3(input)) + 3*{{intStride}};</span>
<span class="s1">	  int intPaddedX = (intIndex % SIZE_3(input)) + 3*{{intStride}};</span>
<span class="s1">	  int intRearrange = ((SIZE_3(input) + 6*{{intStride}}) * intPaddedY) + intPaddedX;</span>

<span class="s1">	  output[(((intSample * SIZE_1(output) * SIZE_2(output)) + intRearrange) * SIZE_1(input)) + intChannel] = dblValue;</span>
<span class="s1">	}</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">kernel_Correlation_updateOutput</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">	extern &quot;C&quot; __global__ void kernel_Correlation_updateOutput(</span>
<span class="s1">	  const int n,</span>
<span class="s1">	  const float* rbot0,</span>
<span class="s1">	  const float* rbot1,</span>
<span class="s1">	  float* top</span>
<span class="s1">	) {</span>
<span class="s1">	  extern __shared__ char patch_data_char[];</span>
<span class="s1">	  </span>
<span class="s1">	  float *patch_data = (float *)patch_data_char;</span>
<span class="s1">	  </span>
<span class="s1">	  // First (upper left) position of kernel upper-left corner in current center position of neighborhood in image 1</span>
<span class="s1">	  int x1 = (blockIdx.x + 3) * {{intStride}};</span>
<span class="s1">	  int y1 = (blockIdx.y + 3) * {{intStride}};</span>
<span class="s1">	  int item = blockIdx.z;</span>
<span class="s1">	  int ch_off = threadIdx.x;</span>
<span class="s1">	  </span>
<span class="s1">	  // Load 3D patch into shared shared memory</span>
<span class="s1">	  for (int j = 0; j &lt; 1; j++) { // HEIGHT</span>
<span class="s1">	    for (int i = 0; i &lt; 1; i++) { // WIDTH</span>
<span class="s1">	      int ji_off = (j + i) * SIZE_3(rbot0);</span>
<span class="s1">	      for (int ch = ch_off; ch &lt; SIZE_3(rbot0); ch += 32) { // CHANNELS</span>
<span class="s1">	        int idx1 = ((item * SIZE_1(rbot0) + y1+j) * SIZE_2(rbot0) + x1+i) * SIZE_3(rbot0) + ch;</span>
<span class="s1">	        int idxPatchData = ji_off + ch;</span>
<span class="s1">	        patch_data[idxPatchData] = rbot0[idx1];</span>
<span class="s1">	      }</span>
<span class="s1">	    }</span>
<span class="s1">	  }</span>
<span class="s1">	  </span>
<span class="s1">	  __syncthreads();</span>
<span class="s1">	  </span>
<span class="s1">	  __shared__ float sum[32];</span>
<span class="s1">	  </span>
<span class="s1">	  // Compute correlation</span>
<span class="s1">	  for (int top_channel = 0; top_channel &lt; SIZE_1(top); top_channel++) {</span>
<span class="s1">	    sum[ch_off] = 0;</span>
<span class="s1">	  </span>
<span class="s1">	    int s2o = (top_channel % 7 - 3) * {{intStride}};</span>
<span class="s1">	    int s2p = (top_channel / 7 - 3) * {{intStride}};</span>
<span class="s1">	    </span>
<span class="s1">	    for (int j = 0; j &lt; 1; j++) { // HEIGHT</span>
<span class="s1">	      for (int i = 0; i &lt; 1; i++) { // WIDTH</span>
<span class="s1">	        int ji_off = (j + i) * SIZE_3(rbot0);</span>
<span class="s1">	        for (int ch = ch_off; ch &lt; SIZE_3(rbot0); ch += 32) { // CHANNELS</span>
<span class="s1">	          int x2 = x1 + s2o;</span>
<span class="s1">	          int y2 = y1 + s2p;</span>
<span class="s1">	          </span>
<span class="s1">	          int idxPatchData = ji_off + ch;</span>
<span class="s1">	          int idx2 = ((item * SIZE_1(rbot0) + y2+j) * SIZE_2(rbot0) + x2+i) * SIZE_3(rbot0) + ch;</span>
<span class="s1">	          </span>
<span class="s1">	          sum[ch_off] += patch_data[idxPatchData] * rbot1[idx2];</span>
<span class="s1">	        }</span>
<span class="s1">	      }</span>
<span class="s1">	    }</span>
<span class="s1">	    </span>
<span class="s1">	    __syncthreads();</span>
<span class="s1">	    </span>
<span class="s1">	    if (ch_off == 0) {</span>
<span class="s1">	      float total_sum = 0;</span>
<span class="s1">	      for (int idx = 0; idx &lt; 32; idx++) {</span>
<span class="s1">	        total_sum += sum[idx];</span>
<span class="s1">	      }</span>
<span class="s1">	      const int sumelems = SIZE_3(rbot0);</span>
<span class="s1">	      const int index = ((top_channel*SIZE_2(top) + blockIdx.y)*SIZE_3(top))+blockIdx.x;</span>
<span class="s1">	      top[index + item*SIZE_1(top)*SIZE_2(top)*SIZE_3(top)] = total_sum / (float)sumelems;</span>
<span class="s1">	    }</span>
<span class="s1">	  }</span>
<span class="s1">	}</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">kernel_Correlation_updateGradFirst</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">	#define ROUND_OFF 50000</span>

<span class="s1">	extern &quot;C&quot; __global__ void kernel_Correlation_updateGradFirst(</span>
<span class="s1">	  const int n,</span>
<span class="s1">	  const int intSample,</span>
<span class="s1">	  const float* rbot0,</span>
<span class="s1">	  const float* rbot1,</span>
<span class="s1">	  const float* gradOutput,</span>
<span class="s1">	  float* gradFirst,</span>
<span class="s1">	  float* gradSecond</span>
<span class="s1">	) { for (int intIndex = (blockIdx.x * blockDim.x) + threadIdx.x; intIndex &lt; n; intIndex += blockDim.x * gridDim.x) {</span>
<span class="s1">	  int n = intIndex % SIZE_1(gradFirst); // channels</span>
<span class="s1">	  int l = (intIndex / SIZE_1(gradFirst)) % SIZE_3(gradFirst) + 3*{{intStride}}; // w-pos</span>
<span class="s1">	  int m = (intIndex / SIZE_1(gradFirst) / SIZE_3(gradFirst)) % SIZE_2(gradFirst) + 3*{{intStride}}; // h-pos</span>
<span class="s1">	  </span>
<span class="s1">	  // round_off is a trick to enable integer division with ceil, even for negative numbers</span>
<span class="s1">	  // We use a large offset, for the inner part not to become negative.</span>
<span class="s1">	  const int round_off = ROUND_OFF;</span>
<span class="s1">	  const int round_off_s1 = {{intStride}} * round_off;</span>
<span class="s1">	  </span>
<span class="s1">	  // We add round_off before_s1 the int division and subtract round_off after it, to ensure the formula matches ceil behavior:</span>
<span class="s1">	  int xmin = (l - 3*{{intStride}} + round_off_s1 - 1) / {{intStride}} + 1 - round_off; // ceil (l - 3*{{intStride}}) / {{intStride}}</span>
<span class="s1">	  int ymin = (m - 3*{{intStride}} + round_off_s1 - 1) / {{intStride}} + 1 - round_off; // ceil (l - 3*{{intStride}}) / {{intStride}}</span>
<span class="s1">	  </span>
<span class="s1">	  // Same here:</span>
<span class="s1">	  int xmax = (l - 3*{{intStride}} + round_off_s1) / {{intStride}} - round_off; // floor (l - 3*{{intStride}}) / {{intStride}}</span>
<span class="s1">	  int ymax = (m - 3*{{intStride}} + round_off_s1) / {{intStride}} - round_off; // floor (m - 3*{{intStride}}) / {{intStride}}</span>
<span class="s1">	  </span>
<span class="s1">	  float sum = 0;</span>
<span class="s1">	  if (xmax&gt;=0 &amp;&amp; ymax&gt;=0 &amp;&amp; (xmin&lt;=SIZE_3(gradOutput)-1) &amp;&amp; (ymin&lt;=SIZE_2(gradOutput)-1)) {</span>
<span class="s1">	    xmin = max(0,xmin);</span>
<span class="s1">	    xmax = min(SIZE_3(gradOutput)-1,xmax);</span>
<span class="s1">	    </span>
<span class="s1">	    ymin = max(0,ymin);</span>
<span class="s1">	    ymax = min(SIZE_2(gradOutput)-1,ymax);</span>
<span class="s1">	    </span>
<span class="s1">	    for (int p = -3; p &lt;= 3; p++) {</span>
<span class="s1">	      for (int o = -3; o &lt;= 3; o++) {</span>
<span class="s1">	        // Get rbot1 data:</span>
<span class="s1">	        int s2o = {{intStride}} * o;</span>
<span class="s1">	        int s2p = {{intStride}} * p;</span>
<span class="s1">	        int idxbot1 = ((intSample * SIZE_1(rbot0) + (m+s2p)) * SIZE_2(rbot0) + (l+s2o)) * SIZE_3(rbot0) + n;</span>
<span class="s1">	        float bot1tmp = rbot1[idxbot1]; // rbot1[l+s2o,m+s2p,n]</span>
<span class="s1">	        </span>
<span class="s1">	        // Index offset for gradOutput in following loops:</span>
<span class="s1">	        int op = (p+3) * 7 + (o+3); // index[o,p]</span>
<span class="s1">	        int idxopoffset = (intSample * SIZE_1(gradOutput) + op);</span>
<span class="s1">	        </span>
<span class="s1">	        for (int y = ymin; y &lt;= ymax; y++) {</span>
<span class="s1">	          for (int x = xmin; x &lt;= xmax; x++) {</span>
<span class="s1">	            int idxgradOutput = (idxopoffset * SIZE_2(gradOutput) + y) * SIZE_3(gradOutput) + x; // gradOutput[x,y,o,p]</span>
<span class="s1">	            sum += gradOutput[idxgradOutput] * bot1tmp;</span>
<span class="s1">	          }</span>
<span class="s1">	        }</span>
<span class="s1">	      }</span>
<span class="s1">	    }</span>
<span class="s1">	  }</span>
<span class="s1">	  const int sumelems = SIZE_1(gradFirst);</span>
<span class="s1">	  const int bot0index = ((n * SIZE_2(gradFirst)) + (m-3*{{intStride}})) * SIZE_3(gradFirst) + (l-3*{{intStride}});</span>
<span class="s1">	  gradFirst[bot0index + intSample*SIZE_1(gradFirst)*SIZE_2(gradFirst)*SIZE_3(gradFirst)] = sum / (float)sumelems;</span>
<span class="s1">	} }</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">kernel_Correlation_updateGradSecond</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">	#define ROUND_OFF 50000</span>

<span class="s1">	extern &quot;C&quot; __global__ void kernel_Correlation_updateGradSecond(</span>
<span class="s1">	  const int n,</span>
<span class="s1">	  const int intSample,</span>
<span class="s1">	  const float* rbot0,</span>
<span class="s1">	  const float* rbot1,</span>
<span class="s1">	  const float* gradOutput,</span>
<span class="s1">	  float* gradFirst,</span>
<span class="s1">	  float* gradSecond</span>
<span class="s1">	) { for (int intIndex = (blockIdx.x * blockDim.x) + threadIdx.x; intIndex &lt; n; intIndex += blockDim.x * gridDim.x) {</span>
<span class="s1">	  int n = intIndex % SIZE_1(gradSecond); // channels</span>
<span class="s1">	  int l = (intIndex / SIZE_1(gradSecond)) % SIZE_3(gradSecond) + 3*{{intStride}}; // w-pos</span>
<span class="s1">	  int m = (intIndex / SIZE_1(gradSecond) / SIZE_3(gradSecond)) % SIZE_2(gradSecond) + 3*{{intStride}}; // h-pos</span>
<span class="s1">	  </span>
<span class="s1">	  // round_off is a trick to enable integer division with ceil, even for negative numbers</span>
<span class="s1">	  // We use a large offset, for the inner part not to become negative.</span>
<span class="s1">	  const int round_off = ROUND_OFF;</span>
<span class="s1">	  const int round_off_s1 = {{intStride}} * round_off;</span>
<span class="s1">	  </span>
<span class="s1">	  float sum = 0;</span>
<span class="s1">	  for (int p = -3; p &lt;= 3; p++) {</span>
<span class="s1">	    for (int o = -3; o &lt;= 3; o++) {</span>
<span class="s1">	      int s2o = {{intStride}} * o;</span>
<span class="s1">	      int s2p = {{intStride}} * p;</span>
<span class="s1">	      </span>
<span class="s1">	      //Get X,Y ranges and clamp</span>
<span class="s1">	      // We add round_off before_s1 the int division and subtract round_off after it, to ensure the formula matches ceil behavior:</span>
<span class="s1">	      int xmin = (l - 3*{{intStride}} - s2o + round_off_s1 - 1) / {{intStride}} + 1 - round_off; // ceil (l - 3*{{intStride}} - s2o) / {{intStride}}</span>
<span class="s1">	      int ymin = (m - 3*{{intStride}} - s2p + round_off_s1 - 1) / {{intStride}} + 1 - round_off; // ceil (l - 3*{{intStride}} - s2o) / {{intStride}}</span>
<span class="s1">	      </span>
<span class="s1">	      // Same here:</span>
<span class="s1">	      int xmax = (l - 3*{{intStride}} - s2o + round_off_s1) / {{intStride}} - round_off; // floor (l - 3*{{intStride}} - s2o) / {{intStride}}</span>
<span class="s1">	      int ymax = (m - 3*{{intStride}} - s2p + round_off_s1) / {{intStride}} - round_off; // floor (m - 3*{{intStride}} - s2p) / {{intStride}}</span>
<span class="s1">          </span>
<span class="s1">	      if (xmax&gt;=0 &amp;&amp; ymax&gt;=0 &amp;&amp; (xmin&lt;=SIZE_3(gradOutput)-1) &amp;&amp; (ymin&lt;=SIZE_2(gradOutput)-1)) {</span>
<span class="s1">	        xmin = max(0,xmin);</span>
<span class="s1">	        xmax = min(SIZE_3(gradOutput)-1,xmax);</span>
<span class="s1">	        </span>
<span class="s1">	        ymin = max(0,ymin);</span>
<span class="s1">	        ymax = min(SIZE_2(gradOutput)-1,ymax);</span>
<span class="s1">	        </span>
<span class="s1">	        // Get rbot0 data:</span>
<span class="s1">	        int idxbot0 = ((intSample * SIZE_1(rbot0) + (m-s2p)) * SIZE_2(rbot0) + (l-s2o)) * SIZE_3(rbot0) + n;</span>
<span class="s1">	        float bot0tmp = rbot0[idxbot0]; // rbot1[l+s2o,m+s2p,n]</span>
<span class="s1">	        </span>
<span class="s1">	        // Index offset for gradOutput in following loops:</span>
<span class="s1">	        int op = (p+3) * 7 + (o+3); // index[o,p]</span>
<span class="s1">	        int idxopoffset = (intSample * SIZE_1(gradOutput) + op);</span>
<span class="s1">	        </span>
<span class="s1">	        for (int y = ymin; y &lt;= ymax; y++) {</span>
<span class="s1">	          for (int x = xmin; x &lt;= xmax; x++) {</span>
<span class="s1">	            int idxgradOutput = (idxopoffset * SIZE_2(gradOutput) + y) * SIZE_3(gradOutput) + x; // gradOutput[x,y,o,p]</span>
<span class="s1">	            sum += gradOutput[idxgradOutput] * bot0tmp;</span>
<span class="s1">	          }</span>
<span class="s1">	        }</span>
<span class="s1">	      }</span>
<span class="s1">	    }</span>
<span class="s1">	  }</span>
<span class="s1">	  const int sumelems = SIZE_1(gradSecond);</span>
<span class="s1">	  const int bot1index = ((n * SIZE_2(gradSecond)) + (m-3*{{intStride}})) * SIZE_3(gradSecond) + (l-3*{{intStride}});</span>
<span class="s1">	  gradSecond[bot1index + intSample*SIZE_1(gradSecond)*SIZE_2(gradSecond)*SIZE_3(gradSecond)] = sum / (float)sumelems;</span>
<span class="s1">	} }</span>
<span class="s1">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="cupy_kernel"><a class="viewcode-back" href="../../../../../DF-VO/libs.deep_models.flow.lite_flow_net.correlation.html#libs.deep_models.flow.lite_flow_net.correlation.cupy_kernel">[docs]</a><span class="k">def</span> <span class="nf">cupy_kernel</span><span class="p">(</span><span class="n">strFunction</span><span class="p">,</span> <span class="n">objectVariables</span><span class="p">):</span>
	<span class="n">strKernel</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">strFunction</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{{intStride}}&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">objectVariables</span><span class="p">[</span><span class="s1">&#39;intStride&#39;</span><span class="p">]))</span>

	<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
		<span class="n">objectMatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(SIZE_)([0-4])(\()([^\)]*)(\))&#39;</span><span class="p">,</span> <span class="n">strKernel</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">objectMatch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">break</span>
		<span class="c1"># end</span>

		<span class="n">intArg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">objectMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

		<span class="n">strTensor</span> <span class="o">=</span> <span class="n">objectMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
		<span class="n">intSizes</span> <span class="o">=</span> <span class="n">objectVariables</span><span class="p">[</span><span class="n">strTensor</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

		<span class="n">strKernel</span> <span class="o">=</span> <span class="n">strKernel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">objectMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">intSizes</span><span class="p">[</span><span class="n">intArg</span><span class="p">]))</span>
	<span class="c1"># end</span>

	<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
		<span class="n">objectMatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(VALUE_)([0-4])(\()([^\)]+)(\))&#39;</span><span class="p">,</span> <span class="n">strKernel</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">objectMatch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">break</span>
		<span class="c1"># end</span>

		<span class="n">intArgs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">objectMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">strArgs</span> <span class="o">=</span> <span class="n">objectMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

		<span class="n">strTensor</span> <span class="o">=</span> <span class="n">strArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">intStrides</span> <span class="o">=</span> <span class="n">objectVariables</span><span class="p">[</span><span class="n">strTensor</span><span class="p">]</span><span class="o">.</span><span class="n">stride</span><span class="p">()</span>
		<span class="n">strIndex</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;((&#39;</span> <span class="o">+</span> <span class="n">strArgs</span><span class="p">[</span><span class="n">intArg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;)*&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">intStrides</span><span class="p">[</span><span class="n">intArg</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="k">for</span> <span class="n">intArg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">intArgs</span><span class="p">)</span> <span class="p">]</span>

		<span class="n">strKernel</span> <span class="o">=</span> <span class="n">strKernel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">objectMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">strTensor</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">strIndex</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
	<span class="c1"># end</span>

	<span class="k">return</span> <span class="n">strKernel</span></div>
<span class="c1"># end</span>

<div class="viewcode-block" id="cupy_launch"><a class="viewcode-back" href="../../../../../DF-VO/libs.deep_models.flow.lite_flow_net.correlation.html#libs.deep_models.flow.lite_flow_net.correlation.cupy_launch">[docs]</a><span class="nd">@cupy</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">for_each_device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cupy_launch</span><span class="p">(</span><span class="n">strFunction</span><span class="p">,</span> <span class="n">strKernel</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">cupy</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">compile_with_cache</span><span class="p">(</span><span class="n">strKernel</span><span class="p">)</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">strFunction</span><span class="p">)</span></div>
<span class="c1"># end</span>

<span class="k">class</span> <span class="nc">_FunctionCorrelation</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>
	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">intStride</span><span class="p">):</span>
		<span class="n">rbot0</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">([</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">intStride</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">intStride</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">])</span>
		<span class="n">rbot1</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">([</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">intStride</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">intStride</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">])</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">rbot0</span><span class="p">,</span> <span class="n">rbot1</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">intStride</span> <span class="o">=</span> <span class="n">intStride</span>

		<span class="k">assert</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
		<span class="k">assert</span><span class="p">(</span><span class="n">second</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

		<span class="n">output</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">([</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">49</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">intStride</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">intStride</span><span class="p">))</span> <span class="p">])</span>

		<span class="k">if</span> <span class="n">first</span><span class="o">.</span><span class="n">is_cuda</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="n">cupy_launch</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_rearrange&#39;</span><span class="p">,</span> <span class="n">cupy_kernel</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_rearrange&#39;</span><span class="p">,</span> <span class="p">{</span>
				<span class="s1">&#39;intStride&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intStride</span><span class="p">,</span>
				<span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">first</span><span class="p">,</span>
				<span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">rbot0</span>
			<span class="p">}))(</span>
				<span class="n">grid</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="nb">int</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">]),</span>
				<span class="n">block</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]),</span>
				<span class="n">args</span><span class="o">=</span><span class="p">[</span> <span class="n">n</span><span class="p">,</span> <span class="n">first</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">rbot0</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">()</span> <span class="p">],</span>
				<span class="n">stream</span><span class="o">=</span><span class="n">Stream</span>
			<span class="p">)</span>

			<span class="n">n</span> <span class="o">=</span> <span class="n">second</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">second</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="n">cupy_launch</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_rearrange&#39;</span><span class="p">,</span> <span class="n">cupy_kernel</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_rearrange&#39;</span><span class="p">,</span> <span class="p">{</span>
				<span class="s1">&#39;intStride&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intStride</span><span class="p">,</span>
				<span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">second</span><span class="p">,</span>
				<span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">rbot1</span>
			<span class="p">}))(</span>
				<span class="n">grid</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="nb">int</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">),</span> <span class="n">second</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">second</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">]),</span>
				<span class="n">block</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]),</span>
				<span class="n">args</span><span class="o">=</span><span class="p">[</span> <span class="n">n</span><span class="p">,</span> <span class="n">second</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">rbot1</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">()</span> <span class="p">],</span>
				<span class="n">stream</span><span class="o">=</span><span class="n">Stream</span>
			<span class="p">)</span>

			<span class="n">n</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="n">cupy_launch</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_updateOutput&#39;</span><span class="p">,</span> <span class="n">cupy_kernel</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_updateOutput&#39;</span><span class="p">,</span> <span class="p">{</span>
				<span class="s1">&#39;intStride&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intStride</span><span class="p">,</span>
				<span class="s1">&#39;rbot0&#39;</span><span class="p">:</span> <span class="n">rbot0</span><span class="p">,</span>
				<span class="s1">&#39;rbot1&#39;</span><span class="p">:</span> <span class="n">rbot1</span><span class="p">,</span>
				<span class="s1">&#39;top&#39;</span><span class="p">:</span> <span class="n">output</span>
			<span class="p">}))(</span>
				<span class="n">grid</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">]),</span>
				<span class="n">block</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]),</span>
				<span class="n">shared_mem</span><span class="o">=</span><span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">args</span><span class="o">=</span><span class="p">[</span> <span class="n">n</span><span class="p">,</span> <span class="n">rbot0</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">rbot1</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">output</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">()</span> <span class="p">],</span>
				<span class="n">stream</span><span class="o">=</span><span class="n">Stream</span>
			<span class="p">)</span>

		<span class="k">elif</span> <span class="n">first</span><span class="o">.</span><span class="n">is_cuda</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

		<span class="c1"># end</span>

		<span class="k">return</span> <span class="n">output</span>
	<span class="c1"># end</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradOutput</span><span class="p">):</span>
		<span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">rbot0</span><span class="p">,</span> <span class="n">rbot1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_tensors</span>

		<span class="k">assert</span><span class="p">(</span><span class="n">gradOutput</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

		<span class="n">gradFirst</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">([</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_input_grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">None</span>
		<span class="n">gradSecond</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">([</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_input_grad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">None</span>

		<span class="k">if</span> <span class="n">first</span><span class="o">.</span><span class="n">is_cuda</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">gradFirst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">intSample</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
					<span class="n">n</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
					<span class="n">cupy_launch</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_updateGradFirst&#39;</span><span class="p">,</span> <span class="n">cupy_kernel</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_updateGradFirst&#39;</span><span class="p">,</span> <span class="p">{</span>
						<span class="s1">&#39;intStride&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intStride</span><span class="p">,</span>
						<span class="s1">&#39;rbot0&#39;</span><span class="p">:</span> <span class="n">rbot0</span><span class="p">,</span>
						<span class="s1">&#39;rbot1&#39;</span><span class="p">:</span> <span class="n">rbot1</span><span class="p">,</span>
						<span class="s1">&#39;gradOutput&#39;</span><span class="p">:</span> <span class="n">gradOutput</span><span class="p">,</span>
						<span class="s1">&#39;gradFirst&#39;</span><span class="p">:</span> <span class="n">gradFirst</span><span class="p">,</span>
						<span class="s1">&#39;gradSecond&#39;</span><span class="p">:</span> <span class="kc">None</span>
					<span class="p">}))(</span>
						<span class="n">grid</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="nb">int</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">512</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]),</span>
						<span class="n">block</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]),</span>
						<span class="n">args</span><span class="o">=</span><span class="p">[</span> <span class="n">n</span><span class="p">,</span> <span class="n">intSample</span><span class="p">,</span> <span class="n">rbot0</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">rbot1</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">gradOutput</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">gradFirst</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="kc">None</span> <span class="p">],</span>
						<span class="n">stream</span><span class="o">=</span><span class="n">Stream</span>
					<span class="p">)</span>
				<span class="c1"># end</span>
			<span class="c1"># end</span>

			<span class="k">if</span> <span class="n">gradSecond</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">intSample</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
					<span class="n">n</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">first</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
					<span class="n">cupy_launch</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_updateGradSecond&#39;</span><span class="p">,</span> <span class="n">cupy_kernel</span><span class="p">(</span><span class="s1">&#39;kernel_Correlation_updateGradSecond&#39;</span><span class="p">,</span> <span class="p">{</span>
						<span class="s1">&#39;intStride&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intStride</span><span class="p">,</span>
						<span class="s1">&#39;rbot0&#39;</span><span class="p">:</span> <span class="n">rbot0</span><span class="p">,</span>
						<span class="s1">&#39;rbot1&#39;</span><span class="p">:</span> <span class="n">rbot1</span><span class="p">,</span>
						<span class="s1">&#39;gradOutput&#39;</span><span class="p">:</span> <span class="n">gradOutput</span><span class="p">,</span>
						<span class="s1">&#39;gradFirst&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
						<span class="s1">&#39;gradSecond&#39;</span><span class="p">:</span> <span class="n">gradSecond</span>
					<span class="p">}))(</span>
						<span class="n">grid</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="nb">int</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">512</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]),</span>
						<span class="n">block</span><span class="o">=</span><span class="nb">tuple</span><span class="p">([</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]),</span>
						<span class="n">args</span><span class="o">=</span><span class="p">[</span> <span class="n">n</span><span class="p">,</span> <span class="n">intSample</span><span class="p">,</span> <span class="n">rbot0</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">rbot1</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">gradOutput</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gradSecond</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">()</span> <span class="p">],</span>
						<span class="n">stream</span><span class="o">=</span><span class="n">Stream</span>
					<span class="p">)</span>
				<span class="c1"># end</span>
			<span class="c1"># end</span>

		<span class="k">elif</span> <span class="n">first</span><span class="o">.</span><span class="n">is_cuda</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

		<span class="c1"># end</span>

		<span class="k">return</span> <span class="n">gradFirst</span><span class="p">,</span> <span class="n">gradSecond</span><span class="p">,</span> <span class="kc">None</span>
	<span class="c1"># end</span>
<span class="c1"># end</span>

<div class="viewcode-block" id="FunctionCorrelation"><a class="viewcode-back" href="../../../../../DF-VO/libs.deep_models.flow.lite_flow_net.correlation.html#libs.deep_models.flow.lite_flow_net.correlation.FunctionCorrelation">[docs]</a><span class="k">def</span> <span class="nf">FunctionCorrelation</span><span class="p">(</span><span class="n">tensorFirst</span><span class="p">,</span> <span class="n">tensorSecond</span><span class="p">,</span> <span class="n">intStride</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">_FunctionCorrelation</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">tensorFirst</span><span class="p">,</span> <span class="n">tensorSecond</span><span class="p">,</span> <span class="n">intStride</span><span class="p">)</span></div>
<span class="c1"># end</span>

<div class="viewcode-block" id="ModuleCorrelation"><a class="viewcode-back" href="../../../../../DF-VO/libs.deep_models.flow.lite_flow_net.correlation.html#libs.deep_models.flow.lite_flow_net.correlation.ModuleCorrelation">[docs]</a><span class="k">class</span> <span class="nc">ModuleCorrelation</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">ModuleCorrelation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
	<span class="c1"># end</span>

<div class="viewcode-block" id="ModuleCorrelation.forward"><a class="viewcode-back" href="../../../../../DF-VO/libs.deep_models.flow.lite_flow_net.correlation.html#libs.deep_models.flow.lite_flow_net.correlation.ModuleCorrelation.forward">[docs]</a>	<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensorFirst</span><span class="p">,</span> <span class="n">tensorSecond</span><span class="p">,</span> <span class="n">intStride</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">_FunctionCorrelation</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">tensorFirst</span><span class="p">,</span> <span class="n">tensorSecond</span><span class="p">,</span> <span class="n">intStride</span><span class="p">)</span></div></div>
	<span class="c1"># end</span>
<span class="c1"># end</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Huangying Zhan

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>