

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>libs.flowlib.flowlib &mdash; DF-VO 0.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> DF-VO
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../rsts/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rsts/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rsts/examples.html">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../DF-VO/apis.html">apis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../DF-VO/libs.html">libs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../DF-VO/tools.html">tools</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DF-VO</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>libs.flowlib.flowlib</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for libs.flowlib.flowlib</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="sd">&#39;&#39;&#39;&#39;&#39;&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># ==============================</span>
<span class="sd"># flowlib.py</span>
<span class="sd"># library for optical flow processing</span>
<span class="sd"># Author: Ruoteng Li</span>
<span class="sd"># Date: 6th Aug 2016</span>
<span class="sd"># ==============================</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">png</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">UNKNOWN_FLOW_THRESH</span> <span class="o">=</span> <span class="mf">1e7</span>
<span class="n">SMALLFLOW</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">LARGEFLOW</span> <span class="o">=</span> <span class="mf">1e8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">=============</span>
<span class="sd">Flow Section</span>
<span class="sd">=============</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TODO"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.TODO">[docs]</a><span class="k">def</span> <span class="nf">TODO</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: </span>
<span class="sd">        update docstring in this page </span>
<span class="sd">    &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="read_flow"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.read_flow">[docs]</a><span class="k">def</span> <span class="nf">read_flow</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read optical flow data from flow file</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        filename (str): name of the flow file</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        flow (array): optical flow data in numpy array (dtype: np.float32)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.flo&#39;</span><span class="p">):</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">read_flo_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">read_kitti_png_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pfm&#39;</span><span class="p">):</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">read_pfm_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid flow file format!&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">flow</span></div>


<div class="viewcode-block" id="write_flow"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.write_flow">[docs]</a><span class="k">def</span> <span class="nf">write_flow</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;write optical flow in Middlebury .flo format</span>

<span class="sd">    Args:</span>
<span class="sd">        flow (array, [HxWx2]): optical flow map</span>
<span class="sd">        filename (str): optical flow file path to be saved</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">magic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">202021.25</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">width</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">height</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">magic</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="save_flow_image"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.save_flow_image">[docs]</a><span class="k">def</span> <span class="nf">save_flow_image</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">image_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;save flow visualization into image file</span>

<span class="sd">    Args:</span>
<span class="sd">        flow (array, [HxWx2]): optical flow data</span>
<span class="sd">        image_file (str): image file path to be saved</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print flow.shape</span>
    <span class="n">flow_img</span> <span class="o">=</span> <span class="n">flow_to_image</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
    <span class="n">img_out</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">flow_img</span><span class="p">)</span>
    <span class="n">img_out</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="flowfile_to_imagefile"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.flowfile_to_imagefile">[docs]</a><span class="k">def</span> <span class="nf">flowfile_to_imagefile</span><span class="p">(</span><span class="n">flow_file</span><span class="p">,</span> <span class="n">image_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert flowfile into image file</span>

<span class="sd">    Args:</span>
<span class="sd">        flow (str): optical flow file path</span>
<span class="sd">        image_file (str): image file path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">read_flow</span><span class="p">(</span><span class="n">flow_file</span><span class="p">)</span>
    <span class="n">save_flow_image</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="flow_error"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.flow_error">[docs]</a><span class="k">def</span> <span class="nf">flow_error</span><span class="p">(</span><span class="n">tu</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate average end point error</span>
<span class="sd">    :param tu: ground-truth horizontal flow map</span>
<span class="sd">    :param tv: ground-truth vertical flow map</span>
<span class="sd">    :param u:  estimated horizontal flow map</span>
<span class="sd">    :param v:  estimated vertical flow map</span>
<span class="sd">    :return: End point error of the estimated flow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">smallflow</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    stu = tu[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    stv = tv[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    su = u[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    sv = v[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">stu</span> <span class="o">=</span> <span class="n">tu</span><span class="p">[:]</span>
    <span class="n">stv</span> <span class="o">=</span> <span class="n">tv</span><span class="p">[:]</span>
    <span class="n">su</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:]</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:]</span>

    <span class="n">idxUnknow</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">stu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">UNKNOWN_FLOW_THRESH</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
        <span class="nb">abs</span><span class="p">(</span><span class="n">stv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">UNKNOWN_FLOW_THRESH</span><span class="p">)</span>
    <span class="n">stu</span><span class="p">[</span><span class="n">idxUnknow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">stv</span><span class="p">[</span><span class="n">idxUnknow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">su</span><span class="p">[</span><span class="n">idxUnknow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sv</span><span class="p">[</span><span class="n">idxUnknow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">ind2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">stu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">smallflow</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">stv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">smallflow</span><span class="p">)]</span>
    <span class="n">index_su</span> <span class="o">=</span> <span class="n">su</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
    <span class="n">index_sv</span> <span class="o">=</span> <span class="n">sv</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
    <span class="n">an</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">index_su</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">index_sv</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">index_stu</span> <span class="o">=</span> <span class="n">stu</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
    <span class="n">index_stv</span> <span class="o">=</span> <span class="n">stv</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
    <span class="n">tn</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">index_stu</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">index_stv</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    angle = un * tun + vn * tvn + (an * tn)</span>
<span class="sd">    index = [angle == 1.0]</span>
<span class="sd">    angle[index] = 0.999</span>
<span class="sd">    ang = np.arccos(angle)</span>
<span class="sd">    mang = np.mean(ang)</span>
<span class="sd">    mang = mang * 180 / np.pi</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">epe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">stu</span> <span class="o">-</span> <span class="n">su</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">stv</span> <span class="o">-</span> <span class="n">sv</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">epe</span> <span class="o">=</span> <span class="n">epe</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
    <span class="n">mepe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epe</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mepe</span></div>


<div class="viewcode-block" id="flow_kitti_error"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.flow_kitti_error">[docs]</a><span class="k">def</span> <span class="nf">flow_kitti_error</span><span class="p">(</span><span class="n">tu</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate average end point error</span>
<span class="sd">    :param tu: ground-truth horizontal flow map</span>
<span class="sd">    :param tv: ground-truth vertical flow map</span>
<span class="sd">    :param u:  estimated horizontal flow map</span>
<span class="sd">    :param v:  estimated vertical flow map</span>
<span class="sd">    :param mask: ground-truth mask</span>
<span class="sd">    :return: End point error of the estimated flow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    stu = tu[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    stv = tv[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    su = u[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    sv = v[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">stu</span> <span class="o">=</span> <span class="n">tu</span><span class="p">[:]</span>
    <span class="n">stv</span> <span class="o">=</span> <span class="n">tv</span><span class="p">[:]</span>
    <span class="n">su</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:]</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:]</span>
    <span class="n">smask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:]</span>

    <span class="n">ind_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">smask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">n_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind_valid</span><span class="p">)</span>

    <span class="n">epe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">stu</span> <span class="o">-</span> <span class="n">su</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">stv</span> <span class="o">-</span> <span class="n">sv</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stu</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">stv</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-5</span>

    <span class="n">epe</span> <span class="o">=</span> <span class="n">epe</span><span class="p">[</span><span class="n">ind_valid</span><span class="p">]</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="n">ind_valid</span><span class="p">]</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">((</span><span class="n">epe</span> <span class="o">&gt;</span> <span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">epe</span> <span class="o">/</span> <span class="n">mag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tau</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">n_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="n">mean_epe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epe</span><span class="p">)</span>
    <span class="n">mean_acc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n_err</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_total</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mean_epe</span><span class="p">,</span> <span class="n">mean_acc</span><span class="p">)</span></div>


<div class="viewcode-block" id="flow_to_image"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.flow_to_image">[docs]</a><span class="k">def</span> <span class="nf">flow_to_image</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">maxrad</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert flow into middlebury color code image</span>

<span class="sd">    Args:</span>
<span class="sd">        flow (array, [HxWx2]): optical flow map</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        img (array, [HxWx3]): optical flow image in middlebury color</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">maxu</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
    <span class="n">maxv</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
    <span class="n">minu</span> <span class="o">=</span> <span class="mf">999.</span>
    <span class="n">minv</span> <span class="o">=</span> <span class="mf">999.</span>

    <span class="n">idxUnknow</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">UNKNOWN_FLOW_THRESH</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">UNKNOWN_FLOW_THRESH</span><span class="p">)</span>
    <span class="n">u</span><span class="p">[</span><span class="n">idxUnknow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">v</span><span class="p">[</span><span class="n">idxUnknow</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">maxrad</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">maxrad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxrad</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxrad</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">compute_color</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">idxUnknow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">img</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">img</span><span class="p">)</span></div>


<div class="viewcode-block" id="evaluate_flow_file"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.evaluate_flow_file">[docs]</a><span class="k">def</span> <span class="nf">evaluate_flow_file</span><span class="p">(</span><span class="n">gt_file</span><span class="p">,</span> <span class="n">pred_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    evaluate the estimated optical flow end point error according to ground truth provided</span>
<span class="sd">    :param gt_file: ground truth file path</span>
<span class="sd">    :param pred_file: estimated optical flow file path</span>
<span class="sd">    :return: end point error, float32</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read flow files and calculate the errors</span>
    <span class="n">gt_flow</span> <span class="o">=</span> <span class="n">read_flow</span><span class="p">(</span><span class="n">gt_file</span><span class="p">)</span>  <span class="c1"># ground truth flow</span>
    <span class="n">eva_flow</span> <span class="o">=</span> <span class="n">read_flow</span><span class="p">(</span><span class="n">pred_file</span><span class="p">)</span>  <span class="c1"># predicted flow</span>
    <span class="c1"># Calculate errors</span>
    <span class="n">average_pe</span> <span class="o">=</span> <span class="n">flow_error</span><span class="p">(</span><span class="n">gt_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">gt_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">eva_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">eva_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">average_pe</span></div>


<div class="viewcode-block" id="evaluate_flow"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.evaluate_flow">[docs]</a><span class="k">def</span> <span class="nf">evaluate_flow</span><span class="p">(</span><span class="n">gt_flow</span><span class="p">,</span> <span class="n">pred_flow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    gt: ground-truth flow</span>
<span class="sd">    pred: estimated flow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">average_pe</span> <span class="o">=</span> <span class="n">flow_error</span><span class="p">(</span><span class="n">gt_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">gt_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">pred_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pred_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">average_pe</span></div>


<div class="viewcode-block" id="evaluate_kitti_flow"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.evaluate_kitti_flow">[docs]</a><span class="k">def</span> <span class="nf">evaluate_kitti_flow</span><span class="p">(</span><span class="n">gt_flow</span><span class="p">,</span> <span class="n">pred_flow</span><span class="p">,</span> <span class="n">rigid_flow</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gt_flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">gt_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">gt_flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gt_flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">epe</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">flow_kitti_error</span><span class="p">(</span><span class="n">gt_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">gt_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="n">pred_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pred_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="n">gt_mask</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">gt_flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">epe</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">flow_kitti_error</span><span class="p">(</span><span class="n">gt_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">gt_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="n">pred_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pred_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="n">gt_flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">epe</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">==============</span>
<span class="sd">Disparity Section</span>
<span class="sd">==============</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="read_disp"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.read_disp">[docs]</a><span class="k">def</span> <span class="nf">read_disp</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="c1"># output: [H, W, 1 or 2]</span>
    <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pfm&#39;</span><span class="p">):</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="o">-</span><span class="n">read_pfm_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">disp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">disp</span><span class="p">)</span> <span class="o">/</span> <span class="mf">256.</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">disp</span><span class="p">,</span> <span class="n">mask</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid disp file format!&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">disp</span></div>


<div class="viewcode-block" id="disp2flow"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.disp2flow">[docs]</a><span class="k">def</span> <span class="nf">disp2flow</span><span class="p">(</span><span class="n">disp</span><span class="p">):</span>
    <span class="n">padder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">disp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">disp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="o">-</span><span class="n">disp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">padder</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">disp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">disp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flow</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">==============</span>
<span class="sd">Others</span>
<span class="sd">==============</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="compute_color"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.compute_color">[docs]</a><span class="k">def</span> <span class="nf">compute_color</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute optical flow color map</span>
<span class="sd">    :param u: optical flow horizontal map</span>
<span class="sd">    :param v: optical flow vertical map</span>
<span class="sd">    :return: optical flow in color code</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">nanIdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">u</span><span class="p">[</span><span class="n">nanIdx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">v</span><span class="p">[</span><span class="n">nanIdx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">colorwheel</span> <span class="o">=</span> <span class="n">make_color_wheel</span><span class="p">()</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">colorwheel</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="o">-</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="n">fk</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">k0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">fk</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">k1</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">k1</span><span class="p">[</span><span class="n">k1</span> <span class="o">==</span> <span class="n">ncols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">fk</span> <span class="o">-</span> <span class="n">k0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">colorwheel</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">colorwheel</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">col0</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">k0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">255</span>
        <span class="n">col1</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">k1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">255</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">col0</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="n">col1</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="n">col</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rad</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">col</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">notidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="n">col</span><span class="p">[</span><span class="n">notidx</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.75</span>
        <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">col</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nanIdx</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="make_color_wheel"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.make_color_wheel">[docs]</a><span class="k">def</span> <span class="nf">make_color_wheel</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate color wheel according Middlebury color code</span>
<span class="sd">    :return: Color wheel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">RY</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">YG</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">GC</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">CB</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">BM</span> <span class="o">=</span> <span class="mi">13</span>
    <span class="n">MR</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="n">ncols</span> <span class="o">=</span> <span class="n">RY</span> <span class="o">+</span> <span class="n">YG</span> <span class="o">+</span> <span class="n">GC</span> <span class="o">+</span> <span class="n">CB</span> <span class="o">+</span> <span class="n">BM</span> <span class="o">+</span> <span class="n">MR</span>

    <span class="n">colorwheel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ncols</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># RY</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">RY</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">RY</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RY</span><span class="p">)</span> <span class="o">/</span> <span class="n">RY</span><span class="p">))</span>
    <span class="n">col</span> <span class="o">+=</span> <span class="n">RY</span>

    <span class="c1"># YG</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">YG</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">YG</span><span class="p">)</span> <span class="o">/</span> <span class="n">YG</span><span class="p">))</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">YG</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">col</span> <span class="o">+=</span> <span class="n">YG</span>

    <span class="c1"># GC</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">GC</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">GC</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GC</span><span class="p">)</span> <span class="o">/</span> <span class="n">GC</span><span class="p">))</span>
    <span class="n">col</span> <span class="o">+=</span> <span class="n">GC</span>

    <span class="c1"># CB</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">CB</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CB</span><span class="p">)</span> <span class="o">/</span> <span class="n">CB</span><span class="p">))</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">CB</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">col</span> <span class="o">+=</span> <span class="n">CB</span>

    <span class="c1"># BM</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">BM</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">BM</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BM</span><span class="p">)</span> <span class="o">/</span> <span class="n">BM</span><span class="p">))</span>
    <span class="n">col</span> <span class="o">+=</span> <span class="o">+</span><span class="n">BM</span>

    <span class="c1"># MR</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">MR</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MR</span><span class="p">)</span> <span class="o">/</span> <span class="n">MR</span><span class="p">))</span>
    <span class="n">colorwheel</span><span class="p">[</span><span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">MR</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="k">return</span> <span class="n">colorwheel</span></div>


<div class="viewcode-block" id="read_flo_file"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.read_flo_file">[docs]</a><span class="k">def</span> <span class="nf">read_flo_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read from Middlebury .flo file</span>
<span class="sd">    :param flow_file: name of the flow file</span>
<span class="sd">    :return: optical flow data in matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">magic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data2d</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="mf">202021.25</span> <span class="o">!=</span> <span class="n">magic</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Magic number incorrect. Invalid .flo file&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># print &quot;Reading %d x %d flow file in .flo format&quot; % (h, w)</span>
        <span class="n">data2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="c1"># reshape data into 3D array (columns, rows, channels)</span>
        <span class="n">data2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">data2d</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data2d</span></div>


<div class="viewcode-block" id="read_png_file"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.read_png_file">[docs]</a><span class="k">def</span> <span class="nf">read_png_file</span><span class="p">(</span><span class="n">flow_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read from KITTI .png file</span>
<span class="sd">    :param flow_file: name of the flow file</span>
<span class="sd">    :return: optical flow data in matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow_object</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">flow_file</span><span class="p">)</span>
    <span class="n">flow_direct</span> <span class="o">=</span> <span class="n">flow_object</span><span class="o">.</span><span class="n">asDirect</span><span class="p">()</span>
    <span class="n">flow_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flow_direct</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="o">=</span> <span class="n">flow_direct</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2"> flow file in .png format&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flow_data</span><span class="p">)):</span>
        <span class="n">flow</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">flow</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">flow</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">invalid_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">**</span><span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="mf">64.0</span>
    <span class="n">flow</span><span class="p">[</span><span class="n">invalid_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">flow</span><span class="p">[</span><span class="n">invalid_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">flow</span></div>


<div class="viewcode-block" id="read_kitti_png_file"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.read_kitti_png_file">[docs]</a><span class="k">def</span> <span class="nf">read_kitti_png_file</span><span class="p">(</span><span class="n">flow_file</span><span class="p">):</span>
    <span class="n">flow_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">flow_file</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">flow_img</span> <span class="o">=</span> <span class="n">flow_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">flow_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">flow_img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">flow_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flow_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">**</span><span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="mf">64.0</span>
    <span class="n">flow_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">flow_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">**</span><span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="mf">64.0</span>
    <span class="n">flow_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">flow_data</span></div>


<div class="viewcode-block" id="read_pfm_file"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.read_pfm_file">[docs]</a><span class="k">def</span> <span class="nf">read_pfm_file</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

    <span class="n">color</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">width</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">height</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">endian</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PF&#39;</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">header</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Pf&#39;</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not a PFM file.&#39;</span><span class="p">)</span>

    <span class="n">dim_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d+)\s(\d+)\s$&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">dim_match</span><span class="p">:</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">dim_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Malformed PFM header.&#39;</span><span class="p">)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># little-endian</span>
        <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="o">-</span><span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span>  <span class="c1"># big-endian</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">endian</span> <span class="o">+</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">color</span> <span class="k">else</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>  <span class="c1">#, scale</span></div>


<div class="viewcode-block" id="resize_flow"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.resize_flow">[docs]</a><span class="k">def</span> <span class="nf">resize_flow</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">des_width</span><span class="p">,</span> <span class="n">des_height</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">):</span>
    <span class="c1"># improper for sparse flow</span>
    <span class="n">src_height</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">src_width</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">src_width</span> <span class="o">==</span> <span class="n">des_width</span> <span class="ow">and</span> <span class="n">src_height</span> <span class="o">==</span> <span class="n">des_height</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flow</span>
    <span class="n">ratio_height</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">des_height</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">src_height</span><span class="p">)</span>
    <span class="n">ratio_width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">des_width</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">src_width</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">:</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">flow</span><span class="p">,</span> <span class="p">(</span><span class="n">des_width</span><span class="p">,</span> <span class="n">des_height</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">flow</span><span class="p">,</span> <span class="p">(</span><span class="n">des_width</span><span class="p">,</span> <span class="n">des_height</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid resize flow method!&#39;</span><span class="p">)</span>
    <span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ratio_width</span>
    <span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ratio_height</span>
    <span class="k">return</span> <span class="n">flow</span></div>


<div class="viewcode-block" id="horizontal_flip_flow"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.horizontal_flip_flow">[docs]</a><span class="k">def</span> <span class="nf">horizontal_flip_flow</span><span class="p">(</span><span class="n">flow</span><span class="p">):</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">flow</span><span class="p">))</span>
    <span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">flow</span></div>


<div class="viewcode-block" id="vertical_flip_flow"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.vertical_flip_flow">[docs]</a><span class="k">def</span> <span class="nf">vertical_flip_flow</span><span class="p">(</span><span class="n">flow</span><span class="p">):</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">flow</span><span class="p">))</span>
    <span class="n">flow</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">flow</span></div>


<div class="viewcode-block" id="remove_ambiguity_flow"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.remove_ambiguity_flow">[docs]</a><span class="k">def</span> <span class="nf">remove_ambiguity_flow</span><span class="p">(</span><span class="n">flow_img</span><span class="p">,</span> <span class="n">err_img</span><span class="p">,</span> <span class="n">threshold_err</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
    <span class="n">thre_flow</span> <span class="o">=</span> <span class="n">flow_img</span>
    <span class="n">mask_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">err_img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">mask_img</span><span class="p">[</span><span class="n">err_img</span> <span class="o">&gt;</span> <span class="n">threshold_err</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">thre_flow</span><span class="p">[</span><span class="n">err_img</span> <span class="o">&gt;</span> <span class="n">threshold_err</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">thre_flow</span><span class="p">,</span> <span class="n">mask_img</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_kitti_png_file"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.write_kitti_png_file">[docs]</a><span class="k">def</span> <span class="nf">write_kitti_png_file</span><span class="p">(</span><span class="n">flow_fn</span><span class="p">,</span> <span class="n">flow_data</span><span class="p">,</span> <span class="n">mask_data</span><span class="p">):</span>
    <span class="n">flow_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">flow_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flow_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
    <span class="n">flow_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">64.0</span> <span class="o">+</span> <span class="mi">2</span><span class="o">**</span><span class="mi">15</span>
    <span class="n">flow_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">64.0</span> <span class="o">+</span> <span class="mi">2</span><span class="o">**</span><span class="mi">15</span>
    <span class="n">flow_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_data</span><span class="p">[:,</span> <span class="p">:]</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">flow_fn</span><span class="p">,</span> <span class="n">flow_img</span><span class="p">)</span></div>


<div class="viewcode-block" id="flow_kitti_mask_error"><a class="viewcode-back" href="../../../DF-VO/libs.flowlib.flowlib.html#libs.flowlib.flowlib.flow_kitti_mask_error">[docs]</a><span class="k">def</span> <span class="nf">flow_kitti_mask_error</span><span class="p">(</span><span class="n">tu</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pd_mask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate average end point error</span>
<span class="sd">    :param tu: ground-truth horizontal flow map</span>
<span class="sd">    :param tv: ground-truth vertical flow map</span>
<span class="sd">    :param gt_mask: ground-truth mask</span>

<span class="sd">    :param u:  estimated horizontal flow map</span>
<span class="sd">    :param v:  estimated vertical flow map</span>
<span class="sd">    :param pd_mask: estimated flow mask</span>
<span class="sd">    :return: End point error of the estimated flow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    stu = tu[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    stv = tv[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    su = u[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    sv = v[bord+1:end-bord,bord+1:end-bord]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">stu</span> <span class="o">=</span> <span class="n">tu</span><span class="p">[:]</span>
    <span class="n">stv</span> <span class="o">=</span> <span class="n">tv</span><span class="p">[:]</span>
    <span class="n">su</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:]</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:]</span>
    <span class="n">s_gt_mask</span> <span class="o">=</span> <span class="n">gt_mask</span><span class="p">[:]</span>
    <span class="n">s_pd_mask</span> <span class="o">=</span> <span class="n">pd_mask</span><span class="p">[:]</span>

    <span class="n">ind_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s_gt_mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s_pd_mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">n_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind_valid</span><span class="p">)</span>

    <span class="n">epe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">stu</span> <span class="o">-</span> <span class="n">su</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">stv</span> <span class="o">-</span> <span class="n">sv</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stu</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">stv</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-5</span>

    <span class="n">epe</span> <span class="o">=</span> <span class="n">epe</span><span class="p">[</span><span class="n">ind_valid</span><span class="p">]</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="n">ind_valid</span><span class="p">]</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">((</span><span class="n">epe</span> <span class="o">&gt;</span> <span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">epe</span> <span class="o">/</span> <span class="n">mag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tau</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">n_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="n">mean_epe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epe</span><span class="p">)</span>
    <span class="n">mean_acc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n_err</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_total</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mean_epe</span><span class="p">,</span> <span class="n">mean_acc</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Huangying Zhan

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>